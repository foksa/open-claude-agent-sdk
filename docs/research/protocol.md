# Claude CLI Protocol Specification

**Date:** 2026-02-02
**Status:** Documentation Complete ✅

---

## Overview

The Claude CLI uses a **NDJSON (Newline-Delimited JSON)** protocol over stdout for communication. Each line of output is a complete JSON object representing a message.

**Source:** [CLAUDE_AGENT_SDK_SPEC.md](https://gist.github.com/SamSaffron/603648958a8c18ceae34939a8951d417)

---

## CLI Spawning

### Basic Command

```bash
claude --print --output-format stream-json --verbose -- "prompt text"
```

### Important Flags

| Flag | Description | Values |
|------|-------------|--------|
| `--print` | Output results to stdout | (flag) |
| `--output-format` | Format of output | `stream-json` |
| `--verbose` | Include detailed output | (flag) |
| `--model` | Claude model to use | `sonnet`, `opus`, `haiku` |
| `--max-turns` | Maximum conversation turns | integer |
| `--max-budget-usd` | Budget limit in USD | float |
| `--system-prompt` | Custom system prompt | string |
| `--setting-sources` | Config sources to load | `user`, `project`, `local` |
| `--strict-mcp-config` | Ignore user MCP servers | (flag) |
| `--no-session-persistence` | Don't save session | (flag) |
| `--` | End of flags, prompt follows | (separator) |

---

## Message Types

### 1. System Messages

Initialization and system events.

```json
{
  "type": "system",
  "subtype": "init",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "model": "claude-sonnet-4-5-20250929",
  "tools": [...],
  "timestamp": "2026-02-02T10:30:00Z"
}
```

### 2. Assistant Messages

Messages generated by Claude.

```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [
      {"type": "text", "text": "Hello"},
      {"type": "tool_use", "id": "toolu_123", "name": "Read", "input": {...}}
    ]
  }
}
```

### 3. User Messages

User input (stdin communication).

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "Follow-up question"
  }
}
```

### 4. Tool Result Messages

Results from tool execution.

```json
{
  "type": "tool_result",
  "tool_use_id": "toolu_123",
  "result": {
    "type": "text",
    "text": "File contents..."
  }
}
```

### 5. Result Messages

Final session result.

```json
{
  "type": "result",
  "subtype": "success",
  "total_cost_usd": 0.023,
  "duration_ms": 3450,
  "usage": {
    "input_tokens": 150,
    "output_tokens": 50,
    "cache_creation_input_tokens": 1200,
    "cache_read_input_tokens": 800
  }
}
```

---

## Control Protocol (stdin/stdout)

### canUseTool Hook

**Purpose:** Ask user for permission before tool execution.

**Flow:**
1. CLI sends `system` message with `subtype: "permission_request"`
2. SDK calls user's `canUseTool` function
3. SDK writes response to stdin: `{"allow": true}` or `{"allow": false}`

**Example:**
```typescript
options: {
  canUseTool: async (name, args) => {
    if (name === "Bash" && args.command.includes("rm")) {
      return false; // Block dangerous commands
    }
    return true;
  }
}
```

### Hooks

**Purpose:** Execute callbacks before/after tool use.

**Available hooks:**
- `pre-tool-use` - Before tool executes
- `post-tool-use` - After tool executes
- `user-prompt-submit` - Before prompt submission

**Example:**
```typescript
options: {
  hooks: {
    'pre-tool-use': async (msg) => {
      console.log(`About to use tool: ${msg.name}`);
    }
  }
}
```

---

## Stdin Communication

### For Multi-Turn Conversations

SDK writes new prompts to CLI stdin:

```json
{"type": "user", "message": {"role": "user", "content": "Follow-up"}}
```

### Using streamInput

```typescript
async function* promptGenerator() {
  yield "First question";
  await sleep(1000);
  yield "Follow-up question";
}

query({
  prompt: promptGenerator(),
  options: { maxTurns: 10 }
})
```

---

## NDJSON Parsing

### Format

Each line is a complete JSON object:

```
{"type":"system","subtype":"init"}
{"type":"assistant","message":{...}}
{"type":"result","subtype":"success"}
```

### Parser Implementation

```typescript
async function* parseNDJSON(readable: Readable) {
  let buffer = '';

  for await (const chunk of readable) {
    buffer += chunk.toString();
    const lines = buffer.split('\n');
    buffer = lines.pop() || '';

    for (const line of lines) {
      if (line.trim()) {
        yield JSON.parse(line);
      }
    }
  }
}
```

---

## CLI Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | General error |
| 2 | Invalid arguments |
| 130 | Interrupted (Ctrl+C) |

---

## Error Handling

### System Errors

```json
{
  "type": "system",
  "subtype": "error",
  "error": {
    "message": "API key not found",
    "code": "auth_error"
  }
}
```

### Result Errors

```json
{
  "type": "result",
  "subtype": "error",
  "error": {
    "message": "Budget exceeded",
    "code": "budget_exceeded"
  }
}
```

---

## Protocol Version

**Current:** `2024-11-05` (protocol date)

**Stability:** Protocol is stable across CLI versions. Breaking changes are rare.

---

## Implementation Notes

### For SDK Authors

1. **Spawn CLI** with proper flags
2. **Parse NDJSON** from stdout line-by-line
3. **Handle stdin** for multi-turn and control protocol
4. **Capture stderr** for debug info (optional)
5. **Monitor process exit** for errors

### For Users

- Protocol is **hidden** - SDK provides clean API
- **No need to understand** protocol details
- SDK handles all communication

---

## References

- [Official Protocol Specification](https://gist.github.com/SamSaffron/603648958a8c18ceae34939a8951d417)
- [MCP Protocol Documentation](https://spec.modelcontextprotocol.io/)
- [Anthropic API Streaming](https://docs.anthropic.com/en/api/streaming)

---

**Date:** 2026-02-02
**Status:** Complete ✅
