# Claude Agent SDK Protocol Specification

## Overview

The Claude Agent SDK uses a **NDJSON (Newline-Delimited JSON)** protocol over stdout for communication between the SDK and the Claude Code CLI. Each line of output is a complete, valid JSON object representing a message.

**Source:** [CLAUDE_AGENT_SDK_SPEC.md](https://gist.github.com/SamSaffron/603648958a8c18ceae34939a8951d417)

## CLI Spawning

### Command Format

```bash
claude --print --output-format stream-json --verbose -- "prompt text"
```

### CLI Flags

| Flag | Description | Values |
|------|-------------|--------|
| `--print` | Output results to stdout | (flag) |
| `--output-format` | Format of output | `stream-json`, `message`, etc. |
| `--verbose` | Include detailed output | (flag) |
| `--model` | Claude model to use | `sonnet`, `opus`, `haiku` |
| `--max-turns` | Maximum conversation turns | integer |
| `--max-budget-usd` | Budget limit in USD | float |
| `--dangerously-skip-permissions` | Bypass permission prompts | (flag) |
| `--resume` | Resume previous session | session-uuid |
| `--` | End of flags, prompt follows | (separator) |

### Example

```bash
claude --print \
  --output-format stream-json \
  --verbose \
  --model sonnet \
  --max-turns 5 \
  --max-budget-usd 0.50 \
  -- "What is 2+2?"
```

## Message Types

The protocol defines **5 primary message types**:

### 1. System Messages

Initialization and system-level events.

**Format:**
```json
{
  "type": "system",
  "subtype": "init",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "model": "claude-sonnet-4-5-20250929",
  "tools": [
    {
      "name": "Read",
      "description": "Reads a file from the local filesystem",
      "input_schema": { ... }
    }
  ],
  "timestamp": "2026-02-02T10:30:00Z"
}
```

**Subtypes:**
- `init` - Session initialization
- `permission_request` - Requesting user permission
- `hook_execution` - Hook callback execution
- `error` - System-level error

### 2. Assistant Messages

Messages generated by Claude.

**Format:**
```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "I'll read the file for you."
      },
      {
        "type": "tool_use",
        "id": "toolu_01A2B3C4D5E6F7G8H9",
        "name": "Read",
        "input": {
          "file_path": "/path/to/file.txt"
        }
      }
    ]
  },
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2026-02-02T10:30:01Z"
}
```

**Content Block Types:**
- `text` - Plain text response
- `tool_use` - Tool invocation request

### 3. User Messages

Tool results and user input.

**Format:**
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_01A2B3C4D5E6F7G8H9",
        "content": "File contents here..."
      }
    ]
  },
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2026-02-02T10:30:02Z"
}
```

**Content Block Types:**
- `tool_result` - Result of tool execution
- `text` - User text input (for multi-turn)

### 4. Result Messages

Final conversation outcome.

**Format:**
```json
{
  "type": "result",
  "subtype": "success",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "num_turns": 3,
  "total_cost_usd": 0.023,
  "input_tokens": 1250,
  "output_tokens": 487,
  "cache_creation_tokens": 0,
  "cache_read_tokens": 0,
  "timestamp": "2026-02-02T10:30:05Z"
}
```

**Subtypes:**
- `success` - Task completed successfully
- `error` - Task failed
- `max_turns_reached` - Hit turn limit
- `budget_exceeded` - Hit budget limit
- `user_cancelled` - User cancelled operation

### 5. Stream Events

Anthropic API streaming events (token-level streaming).

**Format:**
```json
{
  "type": "stream_event",
  "event": {
    "type": "content_block_delta",
    "index": 0,
    "delta": {
      "type": "text_delta",
      "text": "The answer is "
    }
  },
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2026-02-02T10:30:01.123Z"
}
```

**Event Types:**
- `message_start` - Message generation started
- `content_block_start` - Content block started
- `content_block_delta` - Incremental content update
- `content_block_stop` - Content block completed
- `message_delta` - Message metadata update
- `message_stop` - Message generation completed

## Streaming Modes

### Message-Level Streaming (Default)

Each complete message is sent as a single NDJSON line:

```
{"type":"system","subtype":"init",...}
{"type":"assistant","message":{...}}
{"type":"user","message":{...}}
{"type":"result","subtype":"success",...}
```

### Token-Level Streaming (with `--output-format stream-json`)

Includes `stream_event` messages for real-time token delivery:

```
{"type":"system","subtype":"init",...}
{"type":"stream_event","event":{"type":"message_start",...}}
{"type":"stream_event","event":{"type":"content_block_delta","delta":{"text":"The"}}}
{"type":"stream_event","event":{"type":"content_block_delta","delta":{"text":" answer"}}}
{"type":"assistant","message":{...}}
{"type":"result","subtype":"success",...}
```

## Built-in Tools

### Core Tools

| Tool | Description | Key Parameters |
|------|-------------|----------------|
| `Read` | Read file contents | `file_path`, `offset`, `limit` |
| `Write` | Write file | `file_path`, `content` |
| `Edit` | Edit file (string replacement) | `file_path`, `old_string`, `new_string` |
| `Glob` | Find files by pattern | `pattern`, `path` |
| `Grep` | Search file contents | `pattern`, `path`, `output_mode` |
| `Bash` | Execute bash command | `command`, `timeout` |
| `WebFetch` | Fetch URL content | `url`, `prompt` |
| `WebSearch` | Search the web | `query` |
| `Task` | Spawn sub-agent | `prompt`, `subagent_type` |
| `TodoWrite` | Task management | `subject`, `description` |

### Tool Invocation Flow

```
1. SDK sends prompt â†’ Claude CLI
2. CLI outputs: {"type":"assistant", "content":[{"type":"tool_use",...}]}
3. SDK executes tool (built-in or custom)
4. SDK sends: {"type":"user", "content":[{"type":"tool_result",...}]}
5. CLI continues processing
6. CLI outputs: {"type":"result",...}
```

## MCP (Model Context Protocol) Integration

### MCP Server Types

**1. Stdio Transport (Default)**
- Communication via stdin/stdout
- JSON-RPC 2.0 protocol
- Process spawned by Claude CLI

**2. SSE Transport**
- Server-Sent Events over HTTP
- For remote MCP servers

### MCP Tool Naming Convention

```
mcp__<server-name>__<tool-name>
```

Example: `mcp__github__create_issue`

### MCP Message Flow

```
1. SDK registers MCP server config
2. CLI spawns MCP server process
3. CLI sends: initialize (JSON-RPC request)
4. MCP responds: capabilities
5. CLI sends: tools/list
6. MCP responds: available tools
7. Claude uses tool: CLI sends tools/call
8. MCP responds: tool result
```

### MCP JSON-RPC Format

**Initialize:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "claude-code",
      "version": "1.0.0"
    }
  }
}
```

**Tool Call:**
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/call",
  "params": {
    "name": "read_file",
    "arguments": {
      "path": "/path/to/file.txt"
    }
  }
}
```

## Session Management

### Session Storage

Location: `~/.claude/sessions/<session-uuid>/`

**Files:**
- `session.json` - Session metadata
- `messages.jsonl` - Message history (NDJSON)
- `state.json` - Session state

### Resume Session

```bash
claude --print --resume "550e8400-e29b-41d4-a716-446655440000" -- "Continue"
```

**Resume Flow:**
1. CLI loads session from `~/.claude/sessions/<uuid>/`
2. Restores conversation context
3. Continues from last message

## Permission System

### Permission Modes

| Mode | Description |
|------|-------------|
| `default` | Prompt for each tool execution |
| `acceptEdits` | Auto-approve file edits |
| `bypassPermissions` | Auto-approve all tools |
| `plan` | Planning mode (no execution) |

### Permission Request Message

```json
{
  "type": "system",
  "subtype": "permission_request",
  "tool": "Write",
  "params": {
    "file_path": "/path/to/file.txt",
    "content": "..."
  },
  "session_id": "...",
  "timestamp": "..."
}
```

### Bypass Permissions

```bash
claude --dangerously-skip-permissions --print -- "prompt"
```

## Error Handling

### Error Message Format

```json
{
  "type": "result",
  "subtype": "error",
  "error": {
    "type": "api_error",
    "message": "API rate limit exceeded",
    "details": { ... }
  },
  "session_id": "...",
  "timestamp": "..."
}
```

### Error Types

- `api_error` - Anthropic API errors
- `tool_error` - Tool execution failure
- `permission_denied` - User denied permission
- `validation_error` - Invalid input
- `system_error` - Internal system error

## Authentication

### API Key Methods

**1. Environment Variable (Recommended)**
```bash
export ANTHROPIC_API_KEY="sk-ant-..."
claude --print -- "prompt"
```

**2. Config File**
```bash
~/.config/claude/config.json
```

**3. CLI Flag**
```bash
claude --api-key "sk-ant-..." --print -- "prompt"
```

## Protocol Version

**Current Version:** `2024-11-05`

Specified in:
- MCP initialize handshake
- Session metadata
- API requests

## Implementation Notes

### Parsing NDJSON

```typescript
async function* parseNDJSON(stream: ReadableStream): AsyncIterableIterator<SDKMessage> {
  const reader = stream.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop() || ''; // Keep incomplete line in buffer

    for (const line of lines) {
      if (!line.trim()) continue;
      const message = JSON.parse(line) as SDKMessage;
      yield message;
    }
  }
}
```

### Process Spawning (Bun)

```typescript
const process = Bun.spawn([
  'claude',
  '--print',
  '--output-format', 'stream-json',
  '--verbose',
  '--',
  prompt
], {
  stdout: 'pipe',
  stderr: 'pipe',
  env: {
    ANTHROPIC_API_KEY: apiKey,
    ...process.env
  }
});

for await (const message of parseNDJSON(process.stdout)) {
  console.log(message);
}
```

## References

- [Official Protocol Specification](https://gist.github.com/SamSaffron/603648958a8c18ceae34939a8951d417)
- [MCP Protocol Documentation](https://spec.modelcontextprotocol.io/)
- [Anthropic API Streaming](https://docs.anthropic.com/en/api/streaming)
