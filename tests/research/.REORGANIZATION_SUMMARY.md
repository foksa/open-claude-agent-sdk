# Test Research Directory Reorganization

**Date:** 2026-02-02
**Status:** ✅ Complete

---

## What Changed

### Before
```
tests/research/
├── All scripts mixed together (21 files)
├── proxy-cli.js (permanent tool buried with one-offs)
└── logs/
```

### After
```
tests/
├── utils/
│   ├── proxy-cli.js          # ← Promoted to permanent utility
│   └── README.md
│
└── research/
    ├── Active comparison tests (6 scripts)
    ├── comparisons/          # Specific comparison utils
    ├── performance/          # Performance research
    ├── archived/             # Historical one-offs
    └── logs/                 # Proxy outputs
```

---

## Organization Principles

### tests/utils/ (Permanent Tools)
**Criteria:** Reusable, proven value, actively maintained

**Contents:**
- `proxy-cli.js` - The CLI interceptor that discovered the 73% cost bug

### tests/research/ (Active Tests)
**Criteria:** Regularly run for validation, up-to-date

**Contents:**
- `sdk-comparison.ts` - Single-turn comparison
- `multi-turn-comparison.ts` - 5-turn conversation test
- `multi-turn-cli-comparison.ts` - 3-turn CLI comparison
- `compare-with-proxy.ts` - Automated proxy comparison
- `test-official-proxy.ts` - Test Official SDK through proxy
- `test-lite-only.ts` - Test Lite SDK through proxy

### tests/research/comparisons/ (Specific Utils)
**Criteria:** Focused comparison tools

**Contents:**
- `compare-system-init.ts` - Compare system:init messages
- `compare-stdin-messages.ts` - Compare stdin messages

### tests/research/performance/ (Performance Studies)
**Criteria:** Scripts that led to performance.md findings

**Contents:**
- `test-isolation-modes.ts` - Isolation mode comparison
- `test-cost-comparison.ts` - Cost analysis
- `test-claude-md-loading.ts` - CLAUDE.md loading test
- `test-claude-md-quick.ts` - Quick CLAUDE.md test
- `test-system-prompt.ts` - System prompt behavior

### tests/research/archived/ (Historical)
**Criteria:** One-off investigations, superseded by better tools

**Contents:**
- `check-cli-args.ts` - CLI args debugging
- `debug-stdin.ts` - Stdin monitoring
- `inspect-messages.ts` - Direct CLI spawn
- `test-session-persistence.ts` - Flag testing
- `trace-api-calls.ts` - Failed monkey-patching attempt

---

## Path Updates

All references to `proxy-cli.js` updated:
- ✅ `compare-with-proxy.ts` → `./tests/utils/proxy-cli.js`
- ✅ `test-official-proxy.ts` → `./tests/utils/proxy-cli.js`
- ✅ `test-lite-only.ts` → `./tests/utils/proxy-cli.js`

Documentation updated:
- ✅ `docs/guides/REVERSE_ENGINEERING.md`
- ✅ `docs/research/cache-token-investigation.md`
- ✅ `CLAUDE.md`
- ✅ All README files

Proxy log directory:
- ✅ `proxy-cli.js` now logs to `tests/research/logs/` (not `tests/utils/logs/`)

---

## New Documentation

Created READMEs for each subdirectory:
- ✅ `tests/utils/README.md` - Permanent utilities guide
- ✅ `tests/research/archived/README.md` - Historical scripts
- ✅ `tests/research/performance/README.md` - Performance studies
- ✅ `tests/research/comparisons/README.md` - Comparison tools

Updated main README:
- ✅ `tests/research/README.md` - Reflects new structure

---

## Benefits

### Before Reorganization
- ❌ 21 mixed files, hard to find what you need
- ❌ Proxy CLI buried with one-off scripts
- ❌ No clear separation of active vs historical
- ❌ No documentation of what each script does

### After Reorganization
- ✅ Clear hierarchy: permanent → active → specialized → historical
- ✅ Proxy CLI elevated to utility (discoverable)
- ✅ Easy to find active comparison tests
- ✅ Historical context preserved but separate
- ✅ Comprehensive documentation at each level

---

## Future Additions

### Adding to tests/utils/
**Requirements:**
- Must be reusable across scenarios
- Must have proven value
- Must have clear documentation
- Must have example usage

**Process:**
1. Create tool in `tests/utils/`
2. Add to `tests/utils/README.md`
3. Document in `CLAUDE.md` debugging section
4. Add usage examples

### Adding to tests/research/
**Active tests:** Add to main directory
**Specialized comparison:** Add to `comparisons/`
**Performance study:** Add to `performance/`
**One-off investigation:** Add to `archived/`

---

## Verification

All scripts tested:
- ✅ `test-official-proxy.ts` works with new path
- ✅ Logs created in correct location
- ✅ Documentation references updated
- ✅ Directory structure logical

---

## Impact

**For Developers:**
- Easier to find the right tool
- Clear hierarchy for organizing new scripts
- Historical context preserved

**For Future Agents:**
- CLAUDE.md points to utilities
- Clear structure explained in docs
- READMEs guide to right tool for each task

**For Maintenance:**
- Obsolete scripts clearly separated
- Active tools highlighted
- Purpose of each directory documented

---

## Related Changes

This reorganization is part of the broader documentation effort:
- ✅ Created `docs/guides/REVERSE_ENGINEERING.md`
- ✅ Created `docs/research/PROXY_CLI_SUCCESS.md`
- ✅ Updated `docs/research/cache-token-investigation.md`
- ✅ Added debugging section to `CLAUDE.md`

All documentation now points to the correct locations.

---

**Status:** ✅ Complete and verified
**Next:** Ready for commit
